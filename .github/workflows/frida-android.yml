name: Build Undetected Frida Android

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-22.04

    env:
      ANDROID_NDK_VERSION: r26d
      FRIDA_VERSION: 16.1.2

    steps:
    # 1Ô∏è‚É£ Checkout workflow repo
    - name: Checkout repo
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          git curl unzip \
          python3 python3-pip \
          ninja-build pkg-config \
          build-essential \
          libglib2.0-dev \
          libssl-dev

    # 3Ô∏è‚É£ Install Meson
    - name: Install Meson
      run: |
        pip3 install --upgrade meson

    # 4Ô∏è‚É£ Install Android NDK
    - name: Install Android NDK
      run: |
        curl -LO https://dl.google.com/android/repository/android-ndk-${ANDROID_NDK_VERSION}-linux.zip
        unzip -q android-ndk-${ANDROID_NDK_VERSION}-linux.zip
        echo "ANDROID_NDK_ROOT=$PWD/android-ndk-${ANDROID_NDK_VERSION}" >> $GITHUB_ENV

    # 5Ô∏è‚É£ Configure git identity (üî• REQUIRED)
    - name: Configure git identity
      run: |
        git config --global user.name "github-actions"
        git config --global user.email "github-actions@github.com"

    # 6Ô∏è‚É£ Clone Frida (classic layout)
    - name: Clone Frida
      run: |
        git clone --branch ${FRIDA_VERSION} --recurse-submodules https://github.com/frida/frida.git

    # 7Ô∏è‚É£ Clone strongR-frida-android
    - name: Clone strongR-frida-android
      run: |
        git clone https://github.com/0XMohomiester/strongR-frida-android

    # 8Ô∏è‚É£ Debug layout
    - name: Debug Frida layout
      run: |
        ls frida
        ls frida/frida-core

    # 9Ô∏è‚É£ Apply strongR patches
    - name: Apply strongR patches
      run: |
        set -e
        cd frida/frida-core
        git am ../../strongR-frida-android/frida-core/*.patch

    # üîü Verify patches applied
    - name: Verify patches
      run: |
        cd frida/frida-core
        git log --oneline -5

    # 1Ô∏è‚É£1Ô∏è‚É£ Build Frida Android ARM64
    - name: Build Frida Android ARM64
      run: |
        cd frida
        make core-android-arm64

    # 1Ô∏è‚É£2Ô∏è‚É£ Upload artifacts
    - name: Upload Frida binaries
      uses: actions/upload-artifact@v4
      with:
        name: undetected-frida-android-arm64
        path: |
          frida/build/frida-android-arm64/bin/frida-server
          frida/build/frida-android-arm64/lib/frida-gadget.so
